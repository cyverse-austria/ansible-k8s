# templates/kubeadmcfg.yaml.j2
---
apiVersion: "kubeadm.k8s.io/v1beta4"
kind: InitConfiguration
nodeRegistration:
    name: {{ ansible_host }}
localAPIEndpoint:
    advertiseAddress: {{ ansible_host }}
---
apiVersion: "kubeadm.k8s.io/v1beta4"
kind: ClusterConfiguration
etcd:
    local:
        serverCertSANs:
        - "{{ ansible_host }}"
        peerCertSANs:
        - "{{ ansible_host }}"
        extraArgs:
        - name: initial-cluster
          value: {{ groups['etcd_nodes'] | map('regex_replace', '^(.*)$', '"\\1=https://\\1:2380"') | join(',') }}
        - name: initial-cluster-state
          value: new
        - name: name
          value: {{ ansible_host }}
        - name: listen-peer-urls
          value: https://{{ ansible_host }}:2380
        - name: listen-client-urls
          value: https://{{ ansible_host }}:2379
        - name: advertise-client-urls
          value: https://{{ ansible_host }}:2379
        - name: initial-advertise-peer-urls
          value: https://{{ ansible_host }}:2380
